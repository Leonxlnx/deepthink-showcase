<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acoustic Studio 3D - Pro</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');

        body {
            background-color: #050505;
            margin: 0;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            color: #fff;
            user-select: none;
        }

        /* Dynamic Fading Backgrounds */
        .bg-layer {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
            opacity: 0;
            transition: opacity 1.5s ease-in-out;
            z-index: 1;
            filter: brightness(0.4) blur(4px);
        }

        #bg-overlay {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, rgba(0, 0, 0, 0.2) 0%, rgba(0, 0, 0, 0.9) 100%);
            z-index: 2;
            pointer-events: none;
        }

        canvas {
            position: absolute;
            inset: 0;
            z-index: 3;
        }

        #ui {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 10;
            display: flex;
            flex-direction: column;
        }

        .header {
            padding: 40px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        h1 {
            margin: 0;
            font-weight: 300;
            font-size: 1.8rem;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: #e4e4e7;
            text-shadow: 0 4px 15px rgba(0, 0, 0, 0.8);
        }

        h1 b {
            font-weight: 800;
            color: #eab308;
        }

        #hud {
            text-align: right;
            display: none;
            text-shadow: 0 4px 15px rgba(0, 0, 0, 0.8);
        }

        #score {
            font-size: 3.5rem;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 5px;
        }

        #combo {
            font-size: 1rem;
            color: #a1a1aa;
            letter-spacing: 2px;
            font-weight: 600;
            text-transform: uppercase;
        }

        #menu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(15, 15, 20, 0.7);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.9);
            text-align: center;
            pointer-events: auto;
            width: 380px;
            transition: 0.4s opacity, 0.4s transform;
        }

        #menu h2 {
            font-size: 0.9rem;
            color: #a1a1aa;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 25px;
            margin-top: 0;
        }

        .btn {
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.05);
            padding: 16px 20px;
            width: 100%;
            border-radius: 12px;
            font-size: 1rem;
            cursor: pointer;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: 0.2s;
            font-family: inherit;
            font-weight: 500;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            transform: scale(1.02);
        }

        .btn span {
            font-size: 0.7rem;
            background: rgba(0, 0, 0, 0.6);
            padding: 5px 10px;
            border-radius: 6px;
            color: #d4d4d8;
            font-weight: 800;
        }

        .btn-primary {
            background: #eab308;
            color: #000;
            margin-top: 25px;
            font-weight: 800;
            justify-content: center;
            border: none;
            padding: 18px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary:hover {
            background: #fde047;
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(234, 179, 8, 0.3);
        }

        .keys {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            pointer-events: auto;
            opacity: 0;
            transition: 0.5s;
        }

        .key {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.6);
            font-weight: 800;
            font-size: 1.3rem;
            transition: 0.1s;
            backdrop-filter: blur(10px);
            color: #fff;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
        }

        #feedback {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.5rem;
            font-weight: 800;
            color: #fff;
            opacity: 0;
            transition: 0.2s;
            letter-spacing: 6px;
            text-transform: uppercase;
            text-shadow: 0 0 20px currentColor;
        }

        #hint {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            color: #e4e4e7;
            font-size: 0.9rem;
            display: none;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px 30px;
            border-radius: 30px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
            white-space: nowrap;
            backdrop-filter: blur(15px);
            font-weight: 400;
            pointer-events: auto;
        }

        #hint b {
            color: #eab308;
            font-weight: 600;
            margin: 0 4px;
        }

        .back {
            position: absolute;
            top: 40px;
            left: 40px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            display: none;
            pointer-events: auto;
            font-family: inherit;
            transition: 0.2s;
            font-size: 0.9rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .back:hover {
            background: #fff;
            color: #000;
            transform: translateX(-5px);
        }

        #loader {
            position: absolute;
            inset: 0;
            background: #050505;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            letter-spacing: 5px;
            font-size: 1rem;
            color: #fff;
            transition: 0.8s;
            font-weight: 800;
            text-transform: uppercase;
        }
    </style>
</head>

<body>
    <div id="bg-1" class="bg-layer"></div>
    <div id="bg-2" class="bg-layer"></div>
    <div id="bg-overlay"></div>

    <div id="loader">LOADING STUDIO...</div>
    <div id="ui">
        <button class="back" id="btn-back">‚Üê BACK TO MENU</button>
        <div class="header">
            <div style="width: 150px;"></div>
            <h1>Acoustic <b>Pro</b></h1>
            <div id="hud">
                <div id="score">0</div>
                <div id="combo">1x COMBO</div>
            </div>
        </div>

        <div id="menu">
            <h2>Select Track</h2>
            <button class="btn" data-level="1">1. Pop Ballad <span>EASY</span></button>
            <button class="btn" data-level="2">2. Acoustic Rock <span>NORMAL</span></button>
            <button class="btn" data-level="3">3. Spanish Romance <span>HARD</span></button>
            <button class="btn" data-level="4">4. Fast Fingerstyle <span>EXPERT</span></button>
            <button class="btn" data-level="5">5. Epic Master Solo <span>MASTER</span></button>
            <button class="btn btn-primary" id="free-play-btn">Free Mode (Play Any Fret)</button>
        </div>

        <div class="keys" id="game-keys">
            <div id="key-0" class="key">S</div>
            <div id="key-1" class="key">D</div>
            <div id="key-2" class="key">F</div>
            <div id="key-3" class="key">J</div>
            <div id="key-4" class="key">K</div>
            <div id="key-5" class="key">L</div>
        </div>

        <div id="feedback">PERFECT</div>
        <div id="hint"><b>Left Click:</b> Rotate &bull; <b>Right Click:</b> Pan &bull; <b>Scroll:</b> Zoom &bull;
            <b>Click Area:</b> Play Note</div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // ==========================================
        // DYNAMIC BACKGROUND SYSTEM
        // ==========================================
        const bgUrls = {
            menu: 'https://images.unsplash.com/photo-1550291652-6ea9114a47b1?auto=format&fit=crop&q=80&w=1920',
            free: 'https://images.unsplash.com/photo-1510915361894-db8b60106cb1?auto=format&fit=crop&q=80&w=1920',
            1: 'https://images.unsplash.com/photo-1493225457124-a1a2a5f5f4b5?auto=format&fit=crop&q=80&w=1920',
            2: 'https://images.unsplash.com/photo-1516450360452-9312f5e86fc7?auto=format&fit=crop&q=80&w=1920',
            3: 'https://images.unsplash.com/photo-1533558701576-23c65e0272fb?auto=format&fit=crop&q=80&w=1920',
            4: 'https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?auto=format&fit=crop&q=80&w=1920',
            5: 'https://images.unsplash.com/photo-1470229722913-7c092bbfca21?auto=format&fit=crop&q=80&w=1920'
        };
        let activeBg = 1;
        function setBackground(key) {
            const nextBg = activeBg === 1 ? 2 : 1;
            const bgEl = document.getElementById('bg-' + nextBg);
            bgEl.style.backgroundImage = `url('${bgUrls[key]}')`;
            bgEl.style.opacity = 1;
            document.getElementById('bg-' + activeBg).style.opacity = 0;
            activeBg = nextBg;
        }
        setBackground('menu');

        // ==========================================
        // 1. CLEAR & NATURAL AUDIO SYNTHESIZER
        // ==========================================
        let audioCtx, mainGain, reverbNode, compressor;
        const baseFreqs = [82.41, 110.00, 146.83, 196.00, 246.94, 329.63];
        const stringColors = [0xff4444, 0xff9933, 0xffcc00, 0x33cc66, 0x3399ff, 0xcc33ff];

        function initAudio() {
            if (audioCtx) { if (audioCtx.state === 'suspended') audioCtx.resume(); return; }
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();

            compressor = audioCtx.createDynamicsCompressor();
            compressor.threshold.value = -10; compressor.knee.value = 5;
            compressor.ratio.value = 4; compressor.attack.value = 0.002; compressor.release.value = 0.1;
            compressor.connect(audioCtx.destination);

            mainGain = audioCtx.createGain(); mainGain.gain.value = 1.0; mainGain.connect(compressor);

            reverbNode = audioCtx.createDelay(); reverbNode.delayTime.value = 0.04;
            const revFB = audioCtx.createGain(); revFB.gain.value = 0.25;
            const revFilter = audioCtx.createBiquadFilter(); revFilter.type = 'lowpass'; revFilter.frequency.value = 3500;
            reverbNode.connect(revFilter); revFilter.connect(revFB); revFB.connect(reverbNode);
            reverbNode.connect(mainGain);
        }

        function playNote(freq, velocity = 1.0, isMiss = false) {
            if (!audioCtx) return;
            const t = audioCtx.currentTime;
            const pluck = audioCtx.createGain();
            pluck.connect(mainGain);
            if (!isMiss) pluck.connect(reverbNode);

            const oscSaw = audioCtx.createOscillator(); oscSaw.type = isMiss ? 'sine' : 'sawtooth'; oscSaw.frequency.value = freq;
            const oscSine = audioCtx.createOscillator(); oscSine.type = 'sine'; oscSine.frequency.value = freq;

            const lpFilter = audioCtx.createBiquadFilter(); lpFilter.type = 'lowpass';
            lpFilter.frequency.setValueAtTime(freq * (isMiss ? 1.5 : 8), t);
            lpFilter.frequency.exponentialRampToValueAtTime(freq * 1.2, t + 0.3);

            const mSaw = audioCtx.createGain(); mSaw.gain.value = 0.5;
            const mSine = audioCtx.createGain(); mSine.gain.value = 0.8;

            oscSaw.connect(mSaw); oscSine.connect(mSine);
            mSaw.connect(lpFilter); mSine.connect(lpFilter);
            lpFilter.connect(pluck);

            pluck.gain.setValueAtTime(0, t);
            pluck.gain.linearRampToValueAtTime(0.8 * velocity, t + 0.005);
            pluck.gain.exponentialRampToValueAtTime(0.001, t + (isMiss ? 0.15 : 4.0));

            oscSaw.start(t); oscSaw.stop(t + 4.5);
            oscSine.start(t); oscSine.stop(t + 4.5);

            if (!isMiss) {
                const noiseLen = audioCtx.sampleRate * 0.015;
                const buffer = audioCtx.createBuffer(1, noiseLen, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < noiseLen; i++) data[i] = (Math.random() * 2 - 1);
                const noiseSrc = audioCtx.createBufferSource(); noiseSrc.buffer = buffer;
                const noiseFilter = audioCtx.createBiquadFilter(); noiseFilter.type = 'bandpass'; noiseFilter.frequency.value = 3000;
                const noiseGain = audioCtx.createGain();
                noiseGain.gain.setValueAtTime(0.12 * velocity, t); noiseGain.gain.exponentialRampToValueAtTime(0.001, t + 0.02);
                noiseSrc.connect(noiseFilter); noiseFilter.connect(noiseGain); noiseGain.connect(mainGain);
                noiseSrc.start(t);
            }
        }

        // ==========================================
        // 2. HIGHLY DETAILED 3D GUITAR MODEL
        // ==========================================
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 0.1, 200);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.body.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; controls.dampingFactor = 0.05; controls.enabled = false;

        controls.maxDistance = 80; controls.minDistance = 2;
        controls.enablePan = true;
        controls.mouseButtons = { LEFT: THREE.MOUSE.ROTATE, MIDDLE: THREE.MOUSE.DOLLY, RIGHT: THREE.MOUSE.PAN };

        scene.add(new THREE.AmbientLight(0xffffff, 0.7));
        const dirLight = new THREE.DirectionalLight(0xffeedd, 1.5); dirLight.position.set(15, 25, 20); scene.add(dirLight);
        const rimLight = new THREE.DirectionalLight(0x99bbff, 0.8); rimLight.position.set(-15, -10, -10); scene.add(rimLight);

        function createWoodTex(col1, col2, lines = 400) {
            const cvs = document.createElement('canvas'); cvs.width = 1024; cvs.height = 1024;
            const ctx = cvs.getContext('2d'); ctx.fillStyle = col1; ctx.fillRect(0, 0, 1024, 1024);
            for (let i = 0; i < lines; i++) {
                ctx.beginPath(); let x = Math.random() * 1024; ctx.moveTo(x, 0);
                ctx.bezierCurveTo(x + Math.random() * 40, 333, x - Math.random() * 40, 666, x + (Math.random() - 0.5) * 20, 1024);
                ctx.lineWidth = Math.random() * 2 + 0.5; ctx.strokeStyle = col2; ctx.globalAlpha = Math.random() * 0.15; ctx.stroke();
            }
            const tex = new THREE.CanvasTexture(cvs); tex.wrapS = tex.wrapT = THREE.RepeatWrapping; return tex;
        }

        const matTop = new THREE.MeshPhysicalMaterial({ map: createWoodTex('#e8c396', '#b5824c'), roughness: 0.15, metalness: 0.05, clearcoat: 0.4 });
        const matSide = new THREE.MeshStandardMaterial({ map: createWoodTex('#3a1808', '#1c0a02', 200), roughness: 0.5 });
        const matNeck = new THREE.MeshStandardMaterial({ color: 0x1f1008, roughness: 0.9 });
        const matMetal = new THREE.MeshStandardMaterial({ color: 0xe0e0e0, metalness: 0.9, roughness: 0.15 });
        const matIvory = new THREE.MeshStandardMaterial({ color: 0xfffcf0, roughness: 0.3 });
        const matPickguard = new THREE.MeshPhysicalMaterial({ color: 0x0a0301, roughness: 0.1, clearcoat: 0.8 });

        const guitar = new THREE.Group(); scene.add(guitar);

        const scaleLength = 40; const nutY = 28; const bridgeY = nutY - scaleLength;

        const bodyShape = new THREE.Shape();
        bodyShape.moveTo(0, -10);
        bodyShape.bezierCurveTo(6.5, -10, 10.5, -4, 10.5, 1); bodyShape.bezierCurveTo(10.5, 5, 7.5, 7, 6.5, 8);
        bodyShape.bezierCurveTo(5.5, 9, 8.5, 12, 8.5, 15); bodyShape.bezierCurveTo(8.5, 19.5, 4.5, 21.5, 0, 21.5);
        bodyShape.bezierCurveTo(-4.5, 21.5, -8.5, 19.5, -8.5, 15); bodyShape.bezierCurveTo(-8.5, 12, -5.5, 9, -6.5, 8);
        bodyShape.bezierCurveTo(-7.5, 7, -10.5, 5, -10.5, 1); bodyShape.bezierCurveTo(-10.5, -4, -6.5, -10, 0, -10);
        bodyShape.holes.push(new THREE.Path().absarc(0, 10, 2.7, 0, Math.PI * 2, false));

        const binding = new THREE.Mesh(new THREE.ExtrudeGeometry(bodyShape, { depth: 2.85, bevelEnabled: true, bevelSize: 0.25, bevelThickness: 0.25, curveSegments: 48 }), matIvory);
        binding.position.set(0, -12, -2.825); guitar.add(binding);

        const bodyGeo = new THREE.ExtrudeGeometry(bodyShape, { depth: 2.9, bevelEnabled: false, curveSegments: 48 });
        bodyGeo.translate(0, -12, -2.85);
        const body = new THREE.Mesh(bodyGeo, [matTop, matSide]); guitar.add(body);

        const holeBack = new THREE.Mesh(new THREE.PlaneGeometry(6, 6), new THREE.MeshBasicMaterial({ color: 0x030201 }));
        holeBack.position.set(0, -2, -0.1); guitar.add(holeBack);

        const rosette1 = new THREE.Mesh(new THREE.RingGeometry(2.8, 3.1, 64), new THREE.MeshBasicMaterial({ color: 0x110500 }));
        const rosette2 = new THREE.Mesh(new THREE.RingGeometry(3.15, 3.25, 64), new THREE.MeshBasicMaterial({ color: 0xd4a373 }));
        rosette1.position.set(0, -2, 0.06); rosette2.position.set(0, -2, 0.06); guitar.add(rosette1, rosette2);

        const pgShape = new THREE.Shape();
        pgShape.moveTo(0, 5); pgShape.bezierCurveTo(4, 5, 8, 0, 8, -4); pgShape.bezierCurveTo(8, -8, 4, -8, 0, -8); pgShape.lineTo(0, 5);
        pgShape.holes.push(new THREE.Path().absarc(0, 10, 3.0, 0, Math.PI * 2, false));
        const pickguard = new THREE.Mesh(new THREE.ExtrudeGeometry(pgShape, { depth: 0.02, bevelEnabled: false }), matPickguard);
        pickguard.position.set(0, -12, 0.05); guitar.add(pickguard);

        const neck = new THREE.Mesh(new THREE.BoxGeometry(2.2, 22, 1.0), matSide); neck.position.set(0, 18, -0.5); guitar.add(neck);
        const fretboard = new THREE.Mesh(new THREE.BoxGeometry(2.4, 29.5, 0.2), matNeck); fretboard.position.set(0, 13.5, 0.2); guitar.add(fretboard);
        const head = new THREE.Mesh(new THREE.BoxGeometry(2.8, 7, 0.6), matSide); head.position.set(0, 31.5, 0.1); head.rotation.x = -0.15; guitar.add(head);

        for (let i = 0; i < 6; i++) {
            const isLeft = i < 3;
            const y = 29.5 + (i % 3) * 1.8;
            const post = new THREE.Mesh(new THREE.CylinderGeometry(0.12, 0.12, 1.5, 16), matMetal); post.rotation.x = Math.PI / 2;
            post.position.set(isLeft ? -1.6 : 1.6, y, -0.1); guitar.add(post);
            const knob = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.3, 0.15), matMetal);
            knob.position.set(isLeft ? -2.2 : 2.2, y, -0.1); guitar.add(knob);
        }

        const fretsY = [nutY];
        for (let i = 1; i <= 22; i++) {
            const yPos = bridgeY + (scaleLength / Math.pow(2, i / 12));
            fretsY[i] = yPos;
            const fret = new THREE.Mesh(new THREE.CylinderGeometry(0.04, 0.04, 2.38, 8), matMetal);
            fret.rotation.z = Math.PI / 2; fret.position.set(0, yPos, 0.3); guitar.add(fret);

            if ([3, 5, 7, 9, 15, 17, 19, 21].includes(i)) {
                const dot = new THREE.Mesh(new THREE.CircleGeometry(0.15, 32), matIvory);
                dot.position.set(0, (yPos + fretsY[i - 1]) / 2, 0.31); guitar.add(dot);
            } else if (i === 12) {
                const d1 = new THREE.Mesh(new THREE.CircleGeometry(0.12, 32), matIvory);
                d1.position.set(-0.5, (yPos + fretsY[i - 1]) / 2, 0.31); guitar.add(d1);
                const d2 = d1.clone(); d2.position.set(0.5, (yPos + fretsY[i - 1]) / 2, 0.31); guitar.add(d2);
            }
        }

        const bridge = new THREE.Mesh(new THREE.BoxGeometry(5.5, 1.5, 0.6), matNeck); bridge.position.set(0, bridgeY, 0.3); guitar.add(bridge);
        const saddle = new THREE.Mesh(new THREE.BoxGeometry(4.5, 0.15, 0.2), matIvory); saddle.position.set(0, bridgeY + 0.2, 0.6); guitar.add(saddle);
        const nut = new THREE.Mesh(new THREE.BoxGeometry(2.35, 0.4, 0.3), matIvory); nut.position.set(0, nutY, 0.45); guitar.add(nut);

        const stringSpacing = 0.38;
        const stringX = [-1.5 * stringSpacing, -0.5 * stringSpacing, 0.5 * stringSpacing, 1.5 * stringSpacing, 2.5 * stringSpacing, 3.5 * stringSpacing].map(x => x - stringSpacing);
        const strings = [];
        for (let i = 0; i < 6; i++) {
            const thickness = 0.025 - (i * 0.0025);
            const sMesh = new THREE.Mesh(new THREE.CylinderGeometry(thickness, thickness, 40, 8), matMetal);
            sMesh.position.set(stringX[i], 8, 0.5); sMesh.rotation.x = Math.atan2(0.2, 40);
            guitar.add(sMesh); strings.push({ mesh: sMesh, x: stringX[i], vibrate: 0 });

            const pin = new THREE.Mesh(new THREE.CylinderGeometry(0.08, 0.04, 0.4), matIvory);
            const pinTop = new THREE.Mesh(new THREE.SphereGeometry(0.12), matIvory);
            pin.position.set(stringX[i], bridgeY - 0.4, 0.6); pinTop.position.set(stringX[i], bridgeY - 0.2, 0.6);
            guitar.add(pin, pinTop);
        }

        // ==========================================
        // 3. GAME MODE TIMING & TRACK VISUALS
        // ==========================================
        const hitLineY = -4;
        const hitZoneGroup = new THREE.Group(); hitZoneGroup.visible = false; guitar.add(hitZoneGroup);

        for (let i = 0; i < 6; i++) {
            const trackLine = new THREE.Mesh(new THREE.PlaneGeometry(0.03, nutY - hitLineY + 5), new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.15, side: THREE.DoubleSide }));
            trackLine.position.set(stringX[i], (nutY + hitLineY) / 2, 0.6); hitZoneGroup.add(trackLine);
        }

        const hitLineMesh = new THREE.Mesh(new THREE.BoxGeometry(4.5, 0.05, 0.05), new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.5 }));
        hitZoneGroup.add(hitLineMesh);

        const targetRings = [];
        for (let i = 0; i < 6; i++) {
            const ring = new THREE.Mesh(new THREE.RingGeometry(0.18, 0.22, 16), new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.8 }));
            ring.position.set(stringX[i], 0, 0); targetRings.push(ring); hitZoneGroup.add(ring);
        }
        hitZoneGroup.position.set(0, hitLineY, 0.65);

        // ==========================================
        // 4. MASSIVE FREE MODE HITBOXES
        // ==========================================
        const hitPlane = new THREE.Mesh(new THREE.PlaneGeometry(15.0, 45), new THREE.MeshBasicMaterial({ visible: false }));
        hitPlane.position.set(0, 6, 0.5); guitar.add(hitPlane);

        const hoverMat = new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.15, side: THREE.DoubleSide });
        const hoverMarker = new THREE.Mesh(new THREE.PlaneGeometry(1, 1), hoverMat);
        hoverMarker.visible = false; guitar.add(hoverMarker);

        const raycaster = new THREE.Raycaster(); const mouse = new THREE.Vector2();
        let pointerDownPos = { x: 0, y: 0 }; let isDragging = false;
        let activeHoverString = -1, activeHoverFret = 0;

        window.addEventListener('pointerdown', (e) => { pointerDownPos = { x: e.clientX, y: e.clientY }; isDragging = false; });

        window.addEventListener('pointermove', (e) => {
            if (Math.hypot(e.clientX - pointerDownPos.x, e.clientY - pointerDownPos.y) > 4) isDragging = true;
            if (currentMode !== 'free') return;

            mouse.x = (e.clientX / window.innerWidth) * 2 - 1; mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObject(hitPlane);

            if (intersects.length > 0 && !isDragging) {
                const pt = intersects[0].point;

                let sIdx = 0, minDx = 999;
                for (let i = 0; i < 6; i++) { let d = Math.abs(pt.x - stringX[i]); if (d < minDx) { minDx = d; sIdx = i; } }

                let fIdx = 0;
                if (pt.y > fretsY[0]) fIdx = 1; else if (pt.y < fretsY[22]) fIdx = 0;
                else { for (let i = 1; i <= 22; i++) { if (pt.y <= fretsY[i - 1] && pt.y >= fretsY[i]) { fIdx = i; break; } } }

                activeHoverString = sIdx; activeHoverFret = fIdx;

                hoverMarker.geometry.dispose();
                const markerWidth = 1.2;
                if (fIdx === 0) {
                    const height = fretsY[22] - bridgeY;
                    hoverMarker.geometry = new THREE.PlaneGeometry(markerWidth, height);
                    hoverMarker.position.set(stringX[sIdx], bridgeY + height / 2, 0.55);
                } else {
                    const height = fretsY[fIdx - 1] - fretsY[fIdx];
                    hoverMarker.geometry = new THREE.PlaneGeometry(markerWidth, height * 0.95);
                    hoverMarker.position.set(stringX[sIdx], fretsY[fIdx] + height / 2, 0.55);
                }

                hoverMarker.visible = true; document.body.style.cursor = 'pointer';
            } else {
                hoverMarker.visible = false; activeHoverString = -1; document.body.style.cursor = 'default';
            }
        });

        window.addEventListener('pointerup', (e) => {
            if (e.button !== 0 || e.target.tagName === 'BUTTON' || currentMode !== 'free' || isDragging || activeHoverString === -1) return;
            initAudio();
            const freq = baseFreqs[activeHoverString] * Math.pow(2, activeHoverFret / 12);
            playNote(freq, 1.2);
            strings[activeHoverString].vibrate = 0.6;

            hoverMat.opacity = 0.5; setTimeout(() => { hoverMat.opacity = 0.15; }, 120);
        });

        // ==========================================
        // 5. RHYTHM GAME ENGINE
        // ==========================================
        let currentMode = 'menu';
        let score = 0, combo = 0, multiplier = 1, gameStartTime = 0, noteIndex = 0;
        let activeNotes = [], gameSequence = [];
        const spawnY = nutY, fallTime = 1.6, noteSpeed = (spawnY - hitLineY) / fallTime;

        const chordsDict = {
            C: [{ s: 1, f: 3 }, { s: 2, f: 2 }, { s: 3, f: 0 }, { s: 4, f: 1 }], G: [{ s: 0, f: 3 }, { s: 2, f: 0 }, { s: 3, f: 0 }, { s: 4, f: 0 }],
            Am: [{ s: 1, f: 0 }, { s: 2, f: 2 }, { s: 3, f: 2 }, { s: 4, f: 1 }], F: [{ s: 0, f: 1 }, { s: 2, f: 3 }, { s: 3, f: 2 }, { s: 4, f: 1 }],
            Em: [{ s: 0, f: 0 }, { s: 1, f: 2 }, { s: 2, f: 2 }, { s: 3, f: 0 }], D: [{ s: 2, f: 0 }, { s: 3, f: 2 }, { s: 4, f: 3 }]
        };

        function buildLevel(level) {
            let seq = []; let t = 2.0;
            if (level === 1) {
                for (let l = 0; l < 3; l++) { ['C', 'G', 'Am', 'F'].forEach(c => { const ch = chordsDict[c]; seq.push({ time: t, s: ch[0].s, f: ch[0].f }, { time: t + 0.8, s: ch[1].s, f: ch[1].f }, { time: t + 1.6, s: ch[2].s, f: ch[2].f }, { time: t + 2.4, s: ch[3].s, f: ch[3].f }); t += 3.2; }); }
            } else if (level === 2) {
                for (let l = 0; l < 4; l++) { ['Em', 'C', 'G', 'D'].forEach(c => { const ch = chordsDict[c]; seq.push({ time: t, s: ch[0].s, f: ch[0].f }, { time: t + 0.5, s: ch[2].s, f: ch[2].f }, { time: t + 1.0, s: ch[1].s, f: ch[1].f }, { time: t + 1.5, s: ch[3] ? ch[3].s : ch[1].s, f: ch[3] ? ch[3].f : ch[1].f }); t += 2.0; }); }
            } else if (level === 3) {
                for (let l = 0; l < 2; l++) { [[5, 7], [5, 7], [5, 7], [5, 5], [5, 3], [5, 2], [5, 0], [5, 0], [5, 0], [5, 2], [5, 3], [5, 5]].forEach((f, i) => { seq.push({ time: t, s: 5, f: f[1] }, { time: t + 0.33, s: 4, f: 0 }, { time: t + 0.66, s: 3, f: 0 }); if (i % 3 === 0) seq.push({ time: t, s: 0, f: 0 }); t += 1.0; }); }
            } else if (level === 4) {
                for (let l = 0; l < 4; l++) { ['Am', 'F', 'C', 'G'].forEach(c => { const ch = chordsDict[c]; seq.push({ time: t, s: ch[0].s, f: ch[0].f }, { time: t + 0.25, s: ch[2].s, f: ch[2].f }, { time: t + 0.5, s: ch[3] ? ch[3].s : ch[2].s, f: ch[3] ? ch[3].f : ch[2].f }, { time: t + 0.75, s: ch[1].s, f: ch[1].f }, { time: t + 1.0, s: ch[2].s, f: ch[2].f }, { time: t + 1.25, s: ch[3] ? ch[3].s : ch[2].s, f: ch[3] ? ch[3].f : ch[2].f }); t += 1.5; }); }
            } else {
                for (let l = 0; l < 4; l++) { [[0, 0], [1, 2], [2, 2], [3, 1], [4, 0], [5, 0]].forEach((n, i) => seq.push({ time: t + i * 0.2, s: n[0], f: n[1] })); t += 1.2;[[0, 3], [1, 2], [2, 0], [3, 0], [4, 0], [5, 3]].forEach((n, i) => seq.push({ time: t + i * 0.2, s: n[0], f: n[1] })); t += 1.2;[[0, 5], [1, 4], [2, 2], [3, 2], [4, 0], [5, 5]].forEach((n, i) => seq.push({ time: t + i * 0.2, s: n[0], f: n[1] })); t += 1.2;[[0, 7], [1, 6], [2, 4], [3, 4], [4, 0], [5, 7]].forEach((n, i) => seq.push({ time: t + i * 0.2, s: n[0], f: n[1] })); t += 1.2; }
            }
            return seq.map(n => ({ time: n.time, string: n.s, freq: baseFreqs[n.s] * Math.pow(2, n.f / 12) }));
        }

        let fbTimer;
        function showFeedback(txt, isGood = true) {
            const fb = document.getElementById('feedback');
            fb.innerText = txt; fb.style.color = isGood ? '#ffffff' : '#ff4757';
            fb.style.opacity = '1'; fb.style.transform = `translate(-50%, -60%) scale(1.1)`;
            clearTimeout(fbTimer);
            fbTimer = setTimeout(() => { fb.style.opacity = '0'; fb.style.transform = 'translate(-50%, -50%) scale(1)'; }, 350);
        }

        function updateScoreUI() {
            document.getElementById('score').innerText = score;
            document.getElementById('combo').innerText = `${multiplier}x COMBO`;
            document.getElementById('combo').style.color = multiplier > 1 ? '#eab308' : '#a1a1aa';
        }

        function handleStringHit(sIdx) {
            strings[sIdx].vibrate = 0.6;
            const keyEl = document.getElementById('key-' + sIdx);
            if (keyEl) {
                keyEl.style.background = '#fff'; keyEl.style.color = '#000'; keyEl.style.transform = 'scale(0.85)';
                setTimeout(() => { keyEl.style.background = ''; keyEl.style.color = ''; keyEl.style.transform = ''; }, 100);
            }

            if (currentMode === 'game') {
                let hit = false;
                for (let i = 0; i < activeNotes.length; i++) {
                    let note = activeNotes[i];
                    if (note.string === sIdx && Math.abs(note.mesh.position.y - hitLineY) < 2.5) {
                        hit = true;
                        playNote(note.freq, 1.2);

                        guitar.remove(note.mesh); note.mesh.geometry.dispose(); note.mesh.material.dispose();
                        activeNotes.splice(i, 1);

                        targetRings[sIdx].material.color.setHex(stringColors[sIdx]); targetRings[sIdx].material.opacity = 1.0;
                        targetRings[sIdx].scale.set(1.5, 1.5, 1.5);
                        setTimeout(() => { targetRings[sIdx].material.color.setHex(0xffffff); targetRings[sIdx].material.opacity = 0.8; targetRings[sIdx].scale.set(1, 1, 1); }, 150);

                        combo++; if (combo > 20) multiplier = 4; else if (combo > 10) multiplier = 2; else multiplier = 1;
                        score += 10 * multiplier; updateScoreUI();
                        showFeedback(["GOOD", "GREAT", "PERFECT!"][Math.floor(Math.random() * 3)], true); break;
                    }
                }
                if (!hit) {
                    playNote(baseFreqs[sIdx], 0.3, true);
                    combo = 0; multiplier = 1; updateScoreUI(); showFeedback("MISS", false);
                }
            }
        }

        const keys = ['s', 'd', 'f', 'j', 'k', 'l'];
        window.addEventListener('keydown', (e) => {
            if (e.repeat) return; initAudio();
            const idx = keys.indexOf(e.key.toLowerCase());
            if (idx !== -1) {
                if (currentMode === 'free') {
                    const f = activeHoverString !== -1 ? activeHoverFret : 0;
                    playNote(baseFreqs[idx] * Math.pow(2, f / 12), 1.0);
                    strings[idx].vibrate = 0.6;
                    const k = document.getElementById('key-' + idx);
                    if (k) { k.style.background = '#fff'; k.style.color = '#000'; setTimeout(() => { k.style.background = ''; k.style.color = ''; }, 100); }
                } else {
                    handleStringHit(idx);
                }
            }
        });

        // ==========================================
        // 6. UI & CAMERA CONTROL
        // ==========================================
        let targetCamPos = new THREE.Vector3(0, 0, 35);
        let targetCamLook = new THREE.Vector3(0, 10, 0);

        function startGame(lvl) {
            initAudio(); currentMode = 'game'; setBackground(lvl);

            document.getElementById('menu').style.opacity = '0'; document.getElementById('menu').style.pointerEvents = 'none';
            setTimeout(() => document.getElementById('menu').style.display = 'none', 400);
            document.getElementById('hud').style.display = 'block'; document.getElementById('game-keys').style.opacity = '1';
            document.getElementById('hint').style.display = 'none'; document.getElementById('btn-back').style.display = 'block';
            hitZoneGroup.visible = true; controls.enabled = false; hoverMarker.visible = false; document.body.style.cursor = 'default';

            targetCamPos.set(0, -12, 12);
            targetCamLook.set(0, 15, 0);

            gameSequence = buildLevel(lvl);
            activeNotes.forEach(n => { guitar.remove(n.mesh); n.mesh.geometry.dispose(); n.mesh.material.dispose(); });
            activeNotes = []; noteIndex = 0; score = 0; combo = 0; multiplier = 1; updateScoreUI();
            gameStartTime = audioCtx.currentTime + 1.5;
        }

        function startFreeMode() {
            initAudio(); currentMode = 'free'; setBackground('free');

            document.getElementById('menu').style.opacity = '0'; document.getElementById('menu').style.pointerEvents = 'none';
            setTimeout(() => document.getElementById('menu').style.display = 'none', 400);
            document.getElementById('hud').style.display = 'none'; document.getElementById('game-keys').style.opacity = '0';
            document.getElementById('hint').style.display = 'block'; document.getElementById('btn-back').style.display = 'block';
            hitZoneGroup.visible = false;

            controls.enabled = true; controls.target.set(0, 8, 0);
            camera.position.set(8, 8, 28);
            targetCamPos.set(8, 8, 28); targetCamLook.set(0, 8, 0);
        }

        document.getElementById('btn-back').addEventListener('click', () => {
            currentMode = 'menu'; controls.enabled = false; hoverMarker.visible = false; document.body.style.cursor = 'default';
            setBackground('menu');

            document.getElementById('menu').style.display = 'block'; document.getElementById('menu').style.pointerEvents = 'auto';
            setTimeout(() => document.getElementById('menu').style.opacity = '1', 10);
            document.getElementById('hud').style.display = 'none'; document.getElementById('game-keys').style.opacity = '0';
            document.getElementById('hint').style.display = 'none'; document.getElementById('btn-back').style.display = 'none';
            hitZoneGroup.visible = false;

            targetCamPos.set(0, 0, 35); targetCamLook.set(0, 10, 0);
        });

        document.querySelectorAll('.btn[data-level]').forEach(btn => btn.addEventListener('click', (e) => startGame(parseInt(e.currentTarget.dataset.level))));
        document.getElementById('free-play-btn').addEventListener('click', startFreeMode);

        // ==========================================
        // 7. RENDER LOOP
        // ==========================================
        const lookTarget = new THREE.Vector3(0, 10, 0);
        camera.position.copy(targetCamPos); camera.lookAt(targetCamLook);

        function animate() {
            requestAnimationFrame(animate);

            if (!controls.enabled) {
                camera.position.lerp(targetCamPos, 0.04);
                lookTarget.lerp(targetCamLook, 0.04);
                camera.lookAt(lookTarget);
            } else {
                controls.update();
            }

            strings.forEach(s => {
                if (s.vibrate > 0) { s.mesh.position.x = s.x + (Math.random() - 0.5) * s.vibrate; s.vibrate *= 0.85; if (s.vibrate < 0.001) s.vibrate = 0; }
                else s.mesh.position.x = s.x;
            });

            if (currentMode === 'game' && audioCtx) {
                const currentTime = audioCtx.currentTime - gameStartTime;

                while (noteIndex < gameSequence.length && gameSequence[noteIndex].time - fallTime <= currentTime) {
                    const data = gameSequence[noteIndex];
                    const mat = new THREE.MeshStandardMaterial({ color: stringColors[data.string], roughness: 0.1, emissive: stringColors[data.string], emissiveIntensity: 0.5 });
                    const nMesh = new THREE.Mesh(new THREE.BoxGeometry(0.35, 0.45, 0.15), mat);
                    nMesh.position.set(stringX[data.string], spawnY, 0.7);
                    guitar.add(nMesh); activeNotes.push({ ...data, mesh: nMesh }); noteIndex++;
                }

                for (let i = activeNotes.length - 1; i >= 0; i--) {
                    let note = activeNotes[i];
                    note.mesh.position.y = spawnY - (currentTime - (note.time - fallTime)) * noteSpeed;

                    if (note.mesh.position.y < hitLineY - 1.5) {
                        guitar.remove(note.mesh); note.mesh.geometry.dispose(); note.mesh.material.dispose();
                        activeNotes.splice(i, 1);
                        combo = 0; multiplier = 1; updateScoreUI(); showFeedback("MISS", false);
                    }
                }

                if (noteIndex >= gameSequence.length && activeNotes.length === 0) {
                    currentMode = 'menu'; showFeedback("SONG CLEARED!", true);
                    setTimeout(() => document.getElementById('btn-back').click(), 3000);
                }
            }
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });

        setTimeout(() => { const l = document.getElementById('loader'); l.style.opacity = '0'; setTimeout(() => l.style.display = 'none', 800); }, 800);
        animate();
    </script>
</body>

</html>